#!/bin/bash

# Couleurs pour les logs
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fonction pour les logs
log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è $1${NC}"
}

log_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

# Fonction pour v√©rifier si Docker est en cours d'ex√©cution
check_docker() {
    if ! docker info >/dev/null 2>&1; then
        echo "‚ùå Erreur: Docker n'est pas en cours d'ex√©cution."
        echo "‚û°Ô∏è  Veuillez d√©marrer Docker et r√©essayer."
        exit 1
    fi
}

# Fonction pour v√©rifier si docker-compose est install√©
check_docker_compose() {
    if ! command -v docker-compose >/dev/null 2>&1; then
        echo "‚ùå Erreur: docker-compose n'est pas install√©."
        echo "‚û°Ô∏è  Veuillez installer docker-compose et r√©essayer."
        exit 1
    fi
}

# Fonction pour v√©rifier si une image existe
check_image() {
    local service="$1"
    local image="arosa-je-$service"
    
    log_info "V√©rification de l'image Docker pour le service '$service'..."
    if ! docker images --format "{{.Repository}}" | grep -q "^${image}$"; then
        log_warning "üîç Image '$image' non trouv√©e"
        log_info "üèóÔ∏è  Construction de l'image..."
        if docker-compose build "$service"; then
            log_success "‚ú® Image construite avec succ√®s"
        else
            echo "‚ùå Erreur lors de la construction de l'image"
            exit 1
        fi
    else
        log_success "üì¶ Image '$image' trouv√©e"
    fi
}

# Fonction pour v√©rifier la base de donn√©es
check_database() {
    log_info "V√©rification de la base de donn√©es..."
    
    if [ ! -f "./api/assets/database/arosaje.db" ]; then
        echo "‚ùå Base de donn√©es non trouv√©e!"
        echo "‚û°Ô∏è  Veuillez ex√©cuter 'bin/setup-api' avant de lancer les services"
        exit 1
    fi
    
    log_success "Base de donn√©es trouv√©e"
}

# Fonction pour v√©rifier si le dossier de la base de donn√©es existe
check_database_directory() {
    log_info "V√©rification des dossiers n√©cessaires..."
    
    # V√©rification des dossiers requis
    if [ ! -d "./api/assets/database" ] || [ ! -d "./api/assets/img" ]; then
        echo "‚ùå Structure de dossiers incompl√®te!"
        echo "‚û°Ô∏è  Veuillez ex√©cuter 'bin/setup-api' avant de lancer les services"
        exit 1
    fi
    
    # V√©rification de la base de donn√©es
    check_database
    
    log_success "Configuration des dossiers valid√©e"
}

# Fonction pour arr√™ter proprement les conteneurs
cleanup() {
    echo -e "\n\nüõë Arr√™t des conteneurs..."
    
    # Arr√™ter les conteneurs sans les supprimer
    if [ "$1" = "all" ]; then
        docker-compose down
        echo "‚úÖ Tous les services ont √©t√© arr√™t√©s."
    else
        # Convertir les arguments en array pour g√©rer plusieurs services
        local services=($@)
        if [ ${#services[@]} -gt 0 ]; then
            # S'assurer que Redis est arr√™t√© si l'API est arr√™t√©e
            if [[ " ${services[@]} " =~ " api " ]]; then
                docker-compose stop api-redis api "${services[@]}"
            else
                docker-compose stop "${services[@]}"
            fi
            # V√©rifier si les ports sont toujours utilis√©s
            for service in "${services[@]}"; do
                case "$service" in
                    "api")
                        port=8000
                        ;;
                    "web")
                        port=3000
                        # Nettoyer les sockets Nitro
                        docker exec arosa-je-web rm -f /tmp/nitro/worker-*.sock 2>/dev/null || true
                        ;;
                    "mobile")
                        port=5000
                        ;;
                esac
                # Attendre que le port soit lib√©r√©
                timeout=5
                while lsof -i :$port >/dev/null 2>&1 && [ $timeout -gt 0 ]; do
                    sleep 1
                    ((timeout--))
                done
            done
            echo "‚úÖ Services arr√™t√©s : ${services[*]}"
        else
            docker-compose down
            echo "‚úÖ Tous les services ont √©t√© arr√™t√©s."
        fi
    fi
    
    # V√©rification finale des ports
    ports=(8000 3000 5000)
    for port in "${ports[@]}"; do
        if lsof -i :$port >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Le port $port est toujours utilis√©, for√ßage de la lib√©ration..."
            fuser -k $port/tcp >/dev/null 2>&1
        fi
    done

    # Nettoyage final des sockets Nitro si le service web √©tait en cours d'ex√©cution
    if docker ps -q -f name=arosa-je-web >/dev/null 2>&1; then
        echo "üßπ Nettoyage des sockets Nitro..."
        docker exec arosa-je-web rm -f /tmp/nitro/worker-*.sock 2>/dev/null || true
    fi
    
    echo "‚úÖ Tous les ports et sockets ont √©t√© lib√©r√©s"
    exit 0
}

# Fonction pour v√©rifier si un port est disponible
check_port() {
    local port=$1
    if lsof -i :$port >/dev/null 2>&1; then
        echo "‚ùå Le port $port est d√©j√† utilis√©"
        echo "‚û°Ô∏è  Arr√™t du processus utilisant le port $port..."
        fuser -k $port/tcp >/dev/null 2>&1
        sleep 2
    fi
}

# Fonction pour d√©marrer des services sp√©cifiques
start_services() {
    log_info "V√©rification de l'environnement..."
    check_docker
    check_docker_compose
    
    local services=("$@")
    local valid_services=1
    
    # V√©rifier que tous les services sont valides
    for service in "${services[@]}"; do
        case "$service" in
            "api"|"web"|"mobile")
                continue
                ;;
            *)
                echo "‚ùå Service invalide: $service"
                valid_services=0
                ;;
        esac
    done
    
    if [ $valid_services -eq 0 ]; then
        show_help
        exit 1
    fi
    
    # V√©rifier les ports avant de d√©marrer
    for service in "${services[@]}"; do
        case "$service" in
            "api")
                check_port 8000
                ;;
            "web")
                check_port 3000
                ;;
            "mobile")
                check_port 5000
                ;;
        esac
    done
    
    # Configuration sp√©cifique pour l'API si n√©cessaire
    if [[ " ${services[@]} " =~ " api " ]]; then
        check_database_directory
    fi
    
    # V√©rifier et construire les images
    for service in "${services[@]}"; do
        check_image "$service"
    done
    
    # Capture du signal SIGINT
    trap "cleanup ${services[*]}" SIGINT SIGTERM
    
    log_info "D√©marrage des services: ${services[*]}..."
    if ! docker-compose up -d "${services[@]}"; then
        echo "‚ùå Erreur lors du d√©marrage des services."
        echo "üìã Logs de l'erreur:"
        docker-compose logs "${services[@]}"
        exit 1
    fi

    log_success "Services d√©marr√©s avec succ√®s!"
    log_info "Affichage des logs..."
    echo "‚ÑπÔ∏è  Utilisez CTRL+C pour arr√™ter"
    
    # Utiliser --since pour n'afficher que les nouveaux logs
    docker-compose logs -f --since 0s "${services[@]}"
}

# Afficher l'aide
show_help() {
    echo "Usage: bin/up [services...]"
    echo ""
    echo "Options disponibles:"
    echo "  all               - D√©marre tous les services"
    echo "  api web mobile    - D√©marre les services sp√©cifi√©s (dans n'importe quel ordre)"
    echo ""
    echo "Exemples:"
    echo "  bin/up api web    - D√©marre l'API et le frontend web"
    echo "  bin/up api mobile - D√©marre l'API et l'application mobile"
    echo "  bin/up web       - D√©marre uniquement le frontend web"
    echo ""
    exit 1
}

# Fonction pour v√©rifier les fichiers d'environnement
check_env_files() {
    log_info "V√©rification des fichiers d'environnement..."
    
    if [ ! -d "./env" ] || [ ! -f "./env/.env.api" ] || [ ! -f "./env/.env.web" ] || [ ! -f "./env/.env.mobile" ]; then
        echo "‚ùå Fichiers d'environnement manquants!"
        echo "‚û°Ô∏è  Veuillez ex√©cuter 'bin/setup-env' avant de lancer les services"
        exit 1
    fi
    
    # V√©rifier que les fichiers ne sont pas vides
    if [ ! -s "./env/.env.api" ] || [ ! -s "./env/.env.web" ] || [ ! -s "./env/.env.mobile" ]; then
        echo "‚ùå Certains fichiers d'environnement sont vides!"
        echo "‚û°Ô∏è  Veuillez ex√©cuter 'bin/setup-env' pour configurer les variables d'environnement"
        exit 1
    fi
    
    log_success "Fichiers d'environnement valid√©s"
}

case "$1" in
    "all")
        log_info "V√©rification de l'environnement..."
        check_docker
        check_docker_compose
        check_env_files
        check_database_directory
        check_image "api"
        check_image "web"
        check_image "mobile"
        
        # Capture du signal SIGINT pour tous les services
        trap "cleanup all" SIGINT SIGTERM
        
        log_info "D√©marrage de tous les services..."
        if ! docker-compose up -d; then
            echo "‚ùå Erreur lors du d√©marrage des conteneurs."
            echo "üìã Logs de l'erreur:"
            docker-compose logs
            exit 1
        fi

        log_success "Tous les services d√©marr√©s avec succ√®s!"
        log_info "Affichage des logs..."
        echo "‚ÑπÔ∏è  Utilisez CTRL+C pour arr√™ter"
        
        # Utiliser --since pour n'afficher que les nouveaux logs
        docker-compose logs -f --since 0s
        ;;
    "")
        show_help
        ;;
    *)
        log_info "V√©rification de l'environnement..."
        check_docker
        check_docker_compose
        check_env_files
        start_services "$@"
        ;;
esac 